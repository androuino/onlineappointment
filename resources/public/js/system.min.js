var url = "/system/"
var now = new Date();
now.setMinutes(now.getMinutes() - now.getTimezoneOffset());

document.addEventListener("DOMContentLoaded", () => {
    var dateNow = now.toISOString().slice(0,16);
    let data = {}
    function getAllAppointments() {
        loading.show = true;
        table.items.length = 0; // This will clear all the elements without destroying the object
        xhr.get(url + "appts", (res) => {
            if (res.ok) {
                loading.show = false
                res.data.forEach( p => {
                    var number = "" + p.contactNumber;
                    var cNumber = number.replace(number.substring(3, 7), "****");
                    table.items.push({
                        firstName       : p.firstName,
                        lastName        : p.lastName,
                        email           : p.email,
                        contactNumber   : cNumber,
                        appointmentType : p.apptType,
                        appointmentDate : p.apptDate.replace("T", " "),
                        onclick : (ev) => {
                            form.form.pid.value = p.pid;
                            form.form.firstName.value = p.firstName;
                            form.form.lastName.value = p.lastName;
                            form.form.email.value = p.email;
                            form.form.contactNumber.value = number;
                            form.form.apptType.value = p.apptType;
                            form.form.apptDate.value = p.apptDate;
                        }
                    });
                });
            }
        });
    }
    function updateData() {
        loading.show = true;
        table.items.length = 0; // This will clear all the elements without destroying the object
        xhr.get(url + "appts/0/0", (res) => {
            if (res.ok) {
                loading.show = false
                res.data.forEach( p => {
                    var number = "" + p.contactNumber;
                    var cNumber = number.replace(number.substring(3, 7), "****");
                    table.items.push({
                        firstName       : p.firstName,
                        lastName        : p.lastName,
                        email           : p.email,
                        contactNumber   : cNumber,
                        appointmentType : p.apptType,
                        appointmentDate : p.apptDate.replace("T", " "),
                        onclick : (ev) => {
                            form.form.pid.value = p.pid;
                            form.form.firstName.value = p.firstName;
                            form.form.lastName.value = p.lastName;
                            form.form.email.value = p.email;
                            form.form.contactNumber.value = number;
                            form.form.apptType.value = p.apptType;
                            form.form.apptDate.value = p.apptDate;
                        }
                    });
                });
            }
        });
    }
    function getFormData(ev) {
        const form = ev.target;
        const data = {};
        if (form.checkValidity()) {
            const fd = new FormData(form);
            for (let pair of fd.entries()) {
                if (pair[1] != "") {
                    data[pair[0]] = pair[1];
                }
            }
        }
        return data;
    }
    //------------ M2D2 --------------
    var loading = m2d2("#loading", {
        show: false
    });
    var form = m2d2("aside", {
        form : {
            pid : {
                value : ""
            },
            firstName : {
                value : "",
                onkeyup : (ev) => {
                    var arr = ev.target.value.split(' ');
                    var result = '';
                    for (var x = 0; x < arr.length; x++) {
                        result += arr[x].substring(0, 1).toUpperCase() + arr[x].substring(1) + ' ';
                    }
                    ev.target.value = result.substring(0, result.length - 1);
                }
            },
            lastName : {
                value : "",
                onkeyup : (ev) => {
                    var arr = ev.target.value.split(' ');
                    var result = '';
                    for (var x = 0; x < arr.length; x++) {
                        result += arr[x].substring(0, 1).toUpperCase() + arr[x].substring(1) + ' ';
                    }
                    ev.target.value = result.substring(0, result.length - 1);
                }
            },
            email : {
                value : ""
            },
            contactNumber : {
                value : ""
            },
            apptType : {
                value : ""
            },
            apptDate : {
                value : ""
            },
            onsubmit : (ev) => {
                const data = getFormData(ev);
                if (data.firstName != "" && data.lastName != "" &&
                    data.email != "" && data.contactNumber != "" &&
                    data.apptType != "" && data.apptDate != "") { // If validation fails will return empty object
                    console.log(form.form.pid.value);
                    var id = (form.form.pid.value != "undefined") ? 0 : form.form.pid.value
                    xhr.post(url + "update/" + id, data, (res) => {
                        if (res.ok) {
                            //This will redirect to user page after setting cookies.
                            //You can also hide/show parts of the page
                            //window.location.href = res.url;
                            updateData()
                            Swal.fire('Record Saved!')
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Oops...',
                                text: 'Something went wrong!',
                                footer: '<a href>Why do I have this issue?</a>'
                            })
                        }
                    }, () => {
                        console.log("Server error");
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: 'Server error',
                            footer: '<a href>Why do I have this issue?</a>'
                        })
                    });
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'Data is empty!',
                        footer: '<a href>Why do I have this issue?</a>'
                    })
                }
            }
        }
    });
    const submit = m2d2("form button", {
        onclick : (ev) => {
            const item = ev.target;
            item.classList.toggle("active");
            if (item.textContent == "Submit") {
                item.textContent = "Submitted!";
                fetch('/system.button')
                    .then(response => response.json())
                    .then(data =>
                        console.log(data.ok)
                    );
           } else {
                item.textContent = "Submit";
            }
        }
    });
    const table = m2d2("#table", {
        items : []
    });
    //------------ INIT --------------
    getAllAppointments();
});

/**
 * Common XHR method
 * @version 2020-05-09
 *
 * @param method: HTTP method (GET, POST, PUT, DELETE)
 * @param url: service URL
 * @param data: Data object to send (in case of POST and PUT)
 * @param callback: Callback on Success (it will return data)
 * @param error_callback: Callback on Failure
 * @param json : Boolean (if set, it will set request content-type as json and in case of GET, it will send it as body instead of query)
 *
 * @author A.Lepe (dev@alepe.com)
 */
const XHR = function(method, url, data, callback, error_callback, json) {
    const request = new XMLHttpRequest();
    if(json === undefined) { json = false }
    if(data && Object.entries(data).length === 0) {
        data = "";
    }
    if(data) {
        if(method.toUpperCase() === "GET" &&! json) {
            if(data) {
                url += (url.indexOf("?") !== -1 ? "&" : "?") + (Object.keys(data).map(key => key + '=' + data[key]).join('&'));
                data = "";
            }
        } else {
            data = JSON.stringify(data);
        }
    }
    request.open(method, url, true);
    if(json) {
       request.setRequestHeader('Content-Type', 'application/json');
    }
    request.onload = function() {
        const data = request.responseText ? JSON.parse(request.responseText) : {
            error: {type: "Unknown", reason: "Unknown Error"}
        };
        if (request.status >= 200 && request.status < 400) {
        if(callback !== undefined) {
            callback(data);
        }
      } else {
        if(error_callback !== undefined) {
            if(typeof data.error == "string") {
                data.error = { type : "Exception", reason : data.error }
            }
            error_callback(data.error);
        }
      }
    };
    request.send(data);
};
/**
 * Short method. It also validates arguments and allow omitting some, eg.:
 * xhr.get(url, data, callback, error_callback, json);
 * xhr.get(url, callback, error_callback, json);
 * xhr.get(url, data, callback, json);
 * xhr.get(url, data, json);
 * xhr.get(url, callback, json);
 */
const xhr = {};
["get","post","put","delete","connect","options","trace","patch"].forEach(function(method) {
    xhr[method] = function() {
        let url, data, callback, error_callback, json;
        // noinspection FallThroughInSwitchStatementJS
        switch(arguments.length) {
            case 5:
                if(typeof arguments[4] == "boolean") {
                    json = arguments[4];
                } else {
                    console.log("Passed JSON argument: " + arguments[4] + " is not boolean.");
                }
            case 4:
                if(typeof arguments[3] == "function") {
                    error_callback = arguments[3];
                } else if(arguments.length === 4 && typeof arguments[3] == "boolean") {
                    // Make error callback optional:
                    json = arguments[3];
                } else {
                    console.log("Passed argument 4: " + arguments[3] + " is mistaken");
                }
            case 3:
                if(typeof arguments[2] == "function") {
                    if(typeof arguments[1] == "function" && arguments.length < 5) {
                        error_callback = arguments[2];
                    } else {
                        callback = arguments[2];
                    }
                } else if(arguments.length === 3 && typeof arguments[2] == "boolean") {
                    // Make callback and error callback optional:
                    json = arguments[2];
                } else {
                    console.log("Passed argument 3: " + arguments[2] + " is mistaken");
                }
            case 2:
                if(typeof arguments[1] == "object" || typeof arguments[1] == "string") {
                    data = arguments[1];
                } else if(typeof arguments[1] == "function") {
                    // Make data optional:
                    callback = arguments[1];
                } else {
                    console.log("Passed argument 2: " + arguments[1] + " is mistaken");
                }
            case 1:
                if(typeof arguments[0] == "string") {
                    url = arguments[0];
                } else if(Array.isArray(arguments[0])) {
                    url = arguments[0].join("/");
                } else {
                    console.log("Passed URL: "+arguments[0]+" was not a string.");
                }
                break;
            default:
                console.log("Incorrect number of arguments passed to xhr");
        }
        if(data === undefined) { data = {} }
        /*
        console.log("URL: " + url);
        console.log("DATA: " + data);
        console.log("CALLBACK: " + callback);
        console.log("ERROR CALLBACK: " + error_callback);
        console.log("JSON: " + json);
        */
        XHR(method.toUpperCase(), url, data, callback, error_callback, json);
    }
});
